generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Employee {
  id              String    @id @default(uuid())
  employeeCode    String    @unique
  fullName        String
  email           String    @unique
  hireDate        DateTime
  terminationDate DateTime?
  costCenter      String
  costCenterDesc  String    @default("")
  supervisorName  String
  supervisorEmail String
  position        String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  vacationRequests    VacationRequest[]
  earlyReturnRequests EarlyReturnRequest[]
  cashOutRequests     VacationCashOutRequest[]
  vacationAccruals    VacationAccrual[]
  biometricRecords    BiometricRecord[]
  balanceAdjustments  BalanceAdjustment[]
  orgPositions        OrgPosition[]
  staffRequestHires   StaffRequest[] @relation("StaffRequestHire")
}

model VacationRequest {
  id                    String    @id @default(uuid())
  employeeId            String
  employeeName          String
  employeeCode          String
  employeeEmail         String
  supervisorName        String
  supervisorEmail       String
  dateFrom              DateTime
  dateTo                DateTime
  totalDays             Int
  status                String    @default("PENDIENTE")
  currentApprovalLevel  Int       @default(0)
  powerAutomateFlowId   String?
  cancelledAt           DateTime?
  cancelReason          String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  employee            Employee             @relation(fields: [employeeId], references: [id])
  vacationConsumptions VacationConsumption[]
  earlyReturnRequests EarlyReturnRequest[]
}

model EarlyReturnRequest {
  id                      String   @id @default(uuid())
  vacationRequestId       String
  employeeId              String
  returnDate              DateTime
  employeeJustification   String
  approverJustification   String   @default("")
  status                  String   @default("NIVEL_1_PENDIENTE")
  currentApprovalLevel    Int      @default(1)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  vacationRequest VacationRequest @relation(fields: [vacationRequestId], references: [id])
  employee        Employee        @relation(fields: [employeeId], references: [id])
}

model VacationAccrual {
  id                String   @id @default(uuid())
  employeeId        String
  accrualYear       Int
  accrualStartDate  DateTime
  accrualEndDate    DateTime
  monthlyRate       Float    @default(2.5)
  monthsAccrued     Int      @default(0)
  totalDaysAccrued  Float    @default(0)
  totalDaysConsumed Float    @default(0)
  remainingBalance  Float    @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  employee     Employee              @relation(fields: [employeeId], references: [id])
  consumptions VacationConsumption[]

  @@unique([employeeId, accrualYear])
}

model VacationConsumption {
  id                String   @id @default(uuid())
  accrualId         String
  vacationRequestId String?
  cashOutRequestId  String?
  daysConsumed      Float
  consumedAt        DateTime @default(now())

  accrual         VacationAccrual         @relation(fields: [accrualId], references: [id])
  vacationRequest VacationRequest?        @relation(fields: [vacationRequestId], references: [id])
  cashOutRequest  VacationCashOutRequest? @relation(fields: [cashOutRequestId], references: [id])
}

model VacationCashOutRequest {
  id                    String   @id @default(uuid())
  employeeId            String
  employeeName          String
  employeeCode          String
  employeeEmail         String
  supervisorName        String
  supervisorEmail       String
  daysRequested         Int
  status                String   @default("NIVEL_1_PENDIENTE")
  currentApprovalLevel  Int      @default(1)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  employee     Employee              @relation(fields: [employeeId], references: [id])
  consumptions VacationConsumption[]
}

model ApprovalRecord {
  id                    String    @id @default(uuid())
  requestId             String
  requestType           String
  approverEmail         String
  approverName          String
  level                 Int
  status                String    @default("PENDIENTE")
  decidedAt             DateTime?
  comments              String?
  createdAt             DateTime  @default(now())

  @@index([requestId])
}

model SystemConfiguration {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String
  updatedAt   DateTime @updatedAt
  updatedBy   String   @default("system")
}

model BalanceAdjustment {
  id            String   @id @default(uuid())
  employeeId    String
  accrualYear   Int
  adjustmentType String  // CARGA_INICIAL | AJUSTE_MANUAL | CORRECCION
  previousValue Float
  newValue      Float
  daysDelta     Float    // newValue - previousValue
  reason        String
  adjustedBy    String   // email of who made the adjustment
  createdAt     DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
}

model CostCenter {
  id          String   @id @default(uuid())
  code        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model BiometricRecord {
  id           String    @id @default(uuid())
  employeeId   String
  employeeCode String
  date         DateTime
  clockIn      DateTime?
  clockOut     DateTime?
  absenceType  String?
  source       String    @default("BIOMETRICO")
  importedAt   DateTime  @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId, date])
}

model OrgPosition {
  id                String    @id @default(uuid())
  positionCode      String    @unique
  title             String
  costCenter        String
  costCenterDesc    String    @default("")
  reportsToEmail    String
  employeeId        String?
  positionType      String    @default("REGULAR")
  status            String    @default("VACANTE")
  thirdPartyName    String?
  thirdPartyCompany String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  employee       Employee?      @relation(fields: [employeeId], references: [id])
  staffRequests  StaffRequest[]

  @@index([reportsToEmail])
  @@index([costCenter])
  @@index([status])
}

model StaffRequest {
  id                    String    @id @default(uuid())
  requestType           String
  positionId            String?
  positionTitle         String
  costCenter            String
  costCenterDesc        String    @default("")
  reportsToEmail        String
  positionType          String    @default("REGULAR")
  justification         String
  requestedByEmail      String
  requestedByName       String
  supervisorName        String
  supervisorEmail       String
  status                String    @default("NIVEL_1_PENDIENTE")
  currentApprovalLevel  Int       @default(1)
  approvedAt            DateTime?
  hiredEmployeeId       String?
  hiredAt               DateTime?
  cancelledAt           DateTime?
  cancelReason          String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  position      OrgPosition? @relation(fields: [positionId], references: [id])
  hiredEmployee Employee?    @relation("StaffRequestHire", fields: [hiredEmployeeId], references: [id])

  @@index([status])
  @@index([requestedByEmail])
  @@index([positionId])
}
